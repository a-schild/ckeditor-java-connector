/*
 *                   GNU LESSER GENERAL PUBLIC LICENSE
 *                      Version 3, 29 June 2007
 *
 * Copyright (C) 2007 Free Software Foundation, Inc. <http://fsf.org/>
 * Everyone is permitted to copy and distribute verbatim copies
 * of this license document, but changing it is not allowed.
 *
 *
 * This version of the GNU Lesser General Public License incorporates
 * the terms and conditions of version 3 of the GNU General Public
 * License, supplemented by the additional permissions listed below.
 *
 * 0. Additional Definitions.
 *
 * As used herein, "this License" refers to version 3 of the GNU Lesser
 * General Public License, and the "GNU GPL" refers to version 3 of the GNU
 * General Public License.
 * 
 * "The Library" refers to a covered work governed by this License,
 * other than an Application or a Combined Work as defined below.
 * 
 * An "Application" is any work that makes use of an interface provided
 * by the Library, but which is not otherwise based on the Library.
 * Defining a subclass of a class defined by the Library is deemed a mode
 * of using an interface provided by the Library.
 * 
 * A "Combined Work" is a work produced by combining or linking an
 * Application with the Library.  The particular version of the Library
 * with which the Combined Work was made is also called the "Linked
 * Version".
 * 
 * The "Minimal Corresponding Source" for a Combined Work means the
 * Corresponding Source for the Combined Work, excluding any source code
 * for portions of the Combined Work that, considered in isolation, are
 * based on the Application, and not on the Linked Version.
 * 
 * The "Corresponding Application Code" for a Combined Work means the
 * object code and/or source code for the Application, including any data
 * and utility programs needed for reproducing the Combined Work from the
 * Application, but excluding the System Libraries of the Combined Work.
 * 
 * 1. Exception to Section 3 of the GNU GPL.
 * 
 * You may convey a covered work under sections 3 and 4 of this License
 * without being bound by section 3 of the GNU GPL.
 * 
 *   2. Conveying Modified Versions.
 * 
 * If you modify a copy of the Library, and, in your modifications, a
 * facility refers to a function or data to be supplied by an Application
 * that uses the facility (other than as an argument passed when the
 * facility is invoked), then you may convey a copy of the modified
 * version:
 * 
 * a) under this License, provided that you make a good faith effort to
 * ensure that, in the event an Application does not supply the
 * function or data, the facility still operates, and performs
 * whatever part of its purpose remains meaningful, or
 * 
 * b) under the GNU GPL, with none of the additional permissions of
 * this License applicable to that copy.
 * 
 * 3. Object Code Incorporating Material from Library Header Files.
 * 
 * The object code form of an Application may incorporate material from
 * a header file that is part of the Library.  You may convey such object
 * code under terms of your choice, provided that, if the incorporated
 * material is not limited to numerical parameters, data structure
 * layouts and accessors, or small macros, inline functions and templates
 * (ten or fewer lines in length), you do both of the following:
 * 
 * a) Give prominent notice with each copy of the object code that the
 * Library is used in it and that the Library and its use are
 * covered by this License.
 * 
 * b) Accompany the object code with a copy of the GNU GPL and this license
 * document.
 * 
 * 4. Combined Works.
 * 
 * You may convey a Combined Work under terms of your choice that,
 * taken together, effectively do not restrict modification of the
 * portions of the Library contained in the Combined Work and reverse
 * engineering for debugging such modifications, if you also do each of
 * the following:
 * 
 * a) Give prominent notice with each copy of the Combined Work that
 * the Library is used in it and that the Library and its use are
 * covered by this License.
 * 
 * b) Accompany the Combined Work with a copy of the GNU GPL and this license
 * document.
 * 
 * c) For a Combined Work that displays copyright notices during
 * execution, include the copyright notice for the Library among
 * these notices, as well as a reference directing the user to the
 * copies of the GNU GPL and this license document.
 * 
 * d) Do one of the following:
 * 
 *     0) Convey the Minimal Corresponding Source under the terms of this
 *     License, and the Corresponding Application Code in a form
 *     suitable for, and under terms that permit, the user to
 *     recombine or relink the Application with a modified version of
 *     the Linked Version to produce a modified Combined Work, in the
 *     manner specified by section 6 of the GNU GPL for conveying
 *     Corresponding Source.
 * 
 *     1) Use a suitable shared library mechanism for linking with the
 *     Library.  A suitable mechanism is one that (a) uses at run time
 *     a copy of the Library already present on the user's computer
 *     system, and (b) will operate properly with a modified version
 *     of the Library that is interface-compatible with the Linked
 *     Version.
 * 
 * e) Provide Installation Information, but only if you would otherwise
 * be required to provide such information under section 6 of the
 * GNU GPL, and only to the extent that such information is
 * necessary to install and execute a modified version of the
 * Combined Work produced by recombining or relinking the
 * Application with a modified version of the Linked Version. (If
 * you use option 4d0, the Installation Information must accompany
 * the Minimal Corresponding Source and Corresponding Application
 * Code. If you use option 4d1, you must provide the Installation
 * Information in the manner specified by section 6 of the GNU GPL
 * for conveying Corresponding Source.)
 * 
 * 5. Combined Libraries.
 * 
 * You may place library facilities that are a work based on the
 * Library side by side in a single library together with other library
 * facilities that are not Applications and are not covered by this
 * License, and convey such a combined library under terms of your
 * choice, if you do both of the following:
 * 
 * a) Accompany the combined library with a copy of the same work based
 * on the Library, uncombined with any other library facilities,
 * conveyed under the terms of this License.
 * 
 * b) Give prominent notice with the combined library that part of it
 * is a work based on the Library, and explaining where to find the
 * accompanying uncombined form of the same work.
 * 
 * 6. Revised Versions of the GNU Lesser General Public License.
 * 
 * The Free Software Foundation may publish revised and/or new versions
 * of the GNU Lesser General Public License from time to time. Such new
 * versions will be similar in spirit to the present version, but may
 * differ in detail to address new problems or concerns.
 * 
 * Each version is given a distinguishing version number. If the
 * Library as you received it specifies that a certain numbered version
 * of the GNU Lesser General Public License "or any later version"
 * applies to it, you have the option of following the terms and
 * conditions either of that published version or of any later version
 * published by the Free Software Foundation. If the Library as you
 * received it does not specify a version number of the GNU Lesser
 * General Public License, you may choose any version of the GNU Lesser
 * General Public License ever published by the Free Software Foundation.
 * 
 * If the Library as you received it specifies that a proxy can decide
 * whether future versions of the GNU Lesser General Public License shall
 * apply, that proxy's public statement of acceptance of any version is
 * permanent authorization for you to choose that version for the
 * Library.
 */

package org.aarboard.ckeditor.connector;

import com.vaadin.Application;
import com.vaadin.data.Container;
import com.vaadin.data.Property.ValueChangeEvent;
import com.vaadin.data.util.IndexedContainer;
import com.vaadin.event.Action;
import com.vaadin.event.Action.Handler;
import com.vaadin.event.ItemClickEvent;
import com.vaadin.event.ItemClickEvent.ItemClickListener;
import com.vaadin.terminal.Resource;
import com.vaadin.terminal.ThemeResource;
import com.vaadin.terminal.gwt.server.HttpServletRequestListener;
import com.vaadin.terminal.gwt.server.WebBrowser;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Button.ClickListener;
import com.vaadin.ui.Component;
import com.vaadin.ui.HorizontalLayout;
import com.vaadin.ui.HorizontalSplitPanel;
import com.vaadin.ui.Label;
import com.vaadin.ui.Panel;
import com.vaadin.ui.Table;
import com.vaadin.ui.Table.ColumnGenerator;
import com.vaadin.ui.TreeTable;
import com.vaadin.ui.UriFragmentUtility;
import com.vaadin.ui.UriFragmentUtility.FragmentChangedEvent;
import com.vaadin.ui.UriFragmentUtility.FragmentChangedListener;
import com.vaadin.ui.VerticalLayout;
import com.vaadin.ui.Window;
import com.vaadin.ui.Window.Notification;
import java.io.File;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.Iterator;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.aarboard.ckeditor.connector.CKEditorAction.CK_ACTIONS;
import org.aarboard.ckeditor.connector.grid.FlowLayout;
import org.aarboard.ckeditor.connector.providers.IFolder;
import org.aarboard.ckeditor.connector.providers.IIconProvider;
import org.aarboard.ckeditor.connector.providers.IObject;
import org.aarboard.ckeditor.connector.providers.IProvider;
import org.aarboard.ckeditor.connector.providers.IToolbar;
import org.aarboard.ckeditor.connector.providers.filesystem.FileSystemProvider;
import org.aarboard.ckeditor.connector.upload.FileUploader;
import org.aarboard.ckeditor.connector.upload.SimpleFileUploader;
import org.apache.commons.lang.StringEscapeUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.vaadin.addon.borderlayout.BorderLayout;
import org.vaadin.dialogs.ConfirmDialog;
import org.vaadin.notifique.Notifique;
import org.vaadin.notifique.Notifique.Message;
// import org.vaadin.overlay.CustomOverlay;

/**
 *
 * @author a.schild
 */
public class VaadinBrowser extends Application 
     implements FragmentChangedListener, HttpServletRequestListener
{
    private final static Log LOG= LogFactory.getLog(VaadinBrowser.class);

    public static final String  JNDI_INITIAL_CONTEXT= "java:/comp/env"; // Root jndi context to use

    private static final Resource FOLDER = new ThemeResource(
            "../runo/icons/64/folder.png");
    private static final long serialVersionUID = 1L;
    
    private static final String COOKIE_NAME= "VaadinBrowser.config.";

    protected VerticalLayout    _leftPart;  /// Folder browser lives in this part
    protected TreeTable         _folderBrowser;
    protected FolderContainer   _folderContainer;
    protected BorderLayout      _contentArea;
    protected VerticalLayout    _topArea= new VerticalLayout();
    protected ObjectContainer   _objectContainer;
    protected Window            _mainWindow;
    protected CKEditorAction    _currentAction;
    protected Table             _contentTable;
    protected FlowLayout        _contentFlow;
    protected Panel             _flowPanel;
    protected FileUploader      _uploadAreaM;
    protected SimpleFileUploader      _uploadAreaS;
    protected Notifique         _notifications;
    protected HorizontalSplitPanel _splitPanel;
    protected Component         _folderToolbar= null;
    protected Component         _detailToolbar= null;
    
    protected boolean   _isFileBrowser= true;
    private int         _splitterPosition= 200;
    protected boolean   _showAsList= true;
    
    private String    _currentFragment;
    private Label       _captionLabel;
    //private BrowserCookies _cookies;

    
    @Override
    public void init()
    {
        initLayout();
    }

    private void initLayout()
    {
        _splitPanel = new HorizontalSplitPanel();
        _mainWindow= new Window("Vaadin browser", _splitPanel);
        setMainWindow(_mainWindow);
        setTheme("vaadinbrowser");
        // BrowserCookies widget (by default reads the cookie values)
        
        _leftPart = new VerticalLayout();
        _leftPart.setSizeFull();

        /*
        _cookies = new BrowserCookies();
        _leftPart.addComponent(_cookies);
        // Listen when cookies are available and read them
        _cookies.addListener(new BrowserCookies.UpdateListener() {

            public void cookiesUpdated(BrowserCookies bc) 
            {
                String showAsList= bc.getCookie(getCookieName()+"ShowAsList");
                if (showAsList != null)
                {
                    LOG.debug("Show as list is set via cookie:" +showAsList);
                    boolean newListView= showAsList.equals("1");
                    if (newListView == _showAsList)
                    {
                        // Already same view
                    }
                    else
                    {
                        _showAsList= newListView;
                        if (_showAsList)
                        {
                            switchToList();
                        }
                        else
                        {
                            switchToGrid();
                        }
                    }
                }
            }
        });
        */
        
        _folderBrowser= new TreeTable();
        _folderBrowser.setCaption("Folders");

        _folderBrowser.addListener((ItemClickListener) (ItemClickEvent event) -> {
            Object propertyId = event.getPropertyId();
            Object itemId = event.getItemId();
            Object value = _folderBrowser.getValue();
            if (itemId != value)
            {
                _folderBrowser.setValue(itemId);
            }
            else if ("name".equals(propertyId))
            {
                /*
                Field nameField = getNameField((WorkRecord) event
                .getItemId());
                nameField.setReadOnly(false);
                nameField.focus();
                *
                */
            }
            /*
            for (WorkRecord f : workToNameField.keySet()) {
            if (itemId != f) {
            NameField nameField = workToNameField.get(f);
            nameField.setReadOnly(true);
            }
            }
            *
            */
        });

        _folderBrowser.addActionHandler(new Handler()
        {
            // Damn it would be cool if these could be shortcut actions too
            private final Action DELETE = new Action("Delete folder",
                    new ThemeResource("../runo/icons/16/document-delete.png"));
            private final Action ADD = new Action("Create folder", new ThemeResource(
                    "../runo/icons/16/folder-add.png"));
            private final Action RENAME = new Action("Rename folder",
                    new ThemeResource("../runo/icons/16/settings.png"));
            private final Action SELECT = new Action("Select folder",
                    new ThemeResource("../runo/icons/16/ok.png"));

            private final Action[] actions = new Action[] { ADD, DELETE, RENAME, SELECT };

            @Override
            public void handleAction(Action action, Object sender, Object target)
            {
                IFolder newItem = null;
                if (action == ADD)
                {
                    final IFolder item= (IFolder) target;
                    if (item.isCreateFolderAllowed())
                    {
                         ObjectNameDialog dialog= new ObjectNameDialog(
                                 "Create new folder", "Folder name", "", false, (String newName) -> {
                                     if (item.handleFolderCreation(newName))
                                     {
                                         // Update tree
                                         _folderContainer.refresh();
                                     }
                                     else
                                     {
                                         showErrorNotification("Creation of folder failed");
                                     }
                         });
                         _mainWindow.addWindow(dialog);
                    }
                } 
                else if (action == RENAME)
                {
                    final IFolder item= (IFolder) target;
                    if (item.isRenameAllowed())
                    {
                        ObjectNameDialog dialog= new ObjectNameDialog(
                                "Rename folder", "New folder name",
                                item.getName(), true, (String newName) -> {
                                    if (!item.handleFolderRename(newName))
                                    {
                                        showErrorNotification("Rename failed");
                                    }
                                    else
                                    {
                                        // Update tree
                                        _folderContainer.refresh();
                                    }
                        });
                         _mainWindow.addWindow(dialog);
                    }
                } 
                else if (action == DELETE)
                {
                    final IFolder item= (IFolder) target;
                    if (item.isDeleteAllowed())
                    {
                        ConfirmDialog.show(_mainWindow,
                                "Please confirm:",
                                "Do you wish to delete <"+item.getName()+"> ?",
                                "Yes", "No", (ConfirmDialog dialog) -> {
                                    if (dialog.isConfirmed())
                                    {
                                        // Confirmed to continue
                                        LOG.info("Delete folder <"+item.getName()+">");
                                        if (item.handleFolderDelete())
                                        {
                                            // Also remove from detail view
                                            _folderBrowser.getContainerDataSource().removeItem(item);
                                        }
                                        else
                                        {
                                            _mainWindow.showNotification("Delete failed", "Failed to delete <"+item.getName()+">");
                                        }
                                    }
                                    else
                                    {
                                        // User did not confirm
                                        // feedback(dialog.isConfirmed());
                                    }
                        });
                    }
                }
                else if (action == SELECT)
                {
                    final IFolder item= (IFolder) target;
                    if (item.isSelectAllowed())
                    {
                        fileSelected(item.getURL());
                    }
                }

                if (newItem != null) {
                    /*
                    if (!(target instanceof CompositeRecord)) {
                        /*
                         * If add happens on WorkItem add to its parent.
                         */
                       // target = ((WorkRecord) target).getGroupItem();
                    //}
                    //newItem.setGroupItem((CompositeRecord) target);

                    /*
                    container.addItem(newItem);
                    // ensure visible;
                    table.setCollapsed(target, false);
                    table.select(newItem);
                    NameField nameField = getNameField(newItem);
                    nameField.setReadOnly(false);
                    nameField.selectAll();
                     * 
                     */
                }
            }

            private void deleteRow(IFolder target)
            {
                /*
                if (target instanceof CompositeRecord) {
                    CompositeRecord gi = (CompositeRecord) target;
                    WorkRecord[] array = gi.getChildren().toArray(
                            new WorkRecord[gi.getChildren().size()]);
                    for (int i = 0; i < array.length; i++) {
                        deleteRow(array[i]);
                    }

                }
                CompositeRecord groupItem = target.getGroupItem();
                if (groupItem != null) {
                    groupItem.getChildren().remove(target);
                }
                 *
                 */
                /*
                container.removeItem(target);
                if (groupItem != null) {
                    container.fireGroupHourValueChange(target);
                }
                 * 
                 */
            }

            @Override
            public Action[] getActions(Object target, Object sender)
            {
                if (target != null)
                {
                    IFolder folder= (IFolder) target;
                    ArrayList<Action> allowedActions= new ArrayList<>();
                    if (folder.isCreateFolderAllowed())
                    {
                        allowedActions.add(ADD);
                    }
                    if (folder.isDeleteAllowed())
                    {
                        allowedActions.add(DELETE);
                    }
                    if (folder.isRenameAllowed())
                    {
                        allowedActions.add(RENAME);
                    }
                    if (folder.isSelectAllowed())
                    {
                        allowedActions.add(SELECT);
                    }
                    return allowedActions.toArray(new Action[allowedActions.size()]);
                }
                else
                {
                    return null;
                }
            }
        });

        _leftPart.addComponent(_folderBrowser);
        _folderBrowser.addGeneratedColumn("ACTION", new FolderColumnGenerator());
        
        _folderBrowser.setSizeFull();
        _leftPart.setExpandRatio(_folderBrowser, 1);
        _splitPanel.addComponent(_leftPart);
        _contentArea= new BorderLayout();
        _contentArea.setSizeFull();
        _splitPanel.addComponent(_contentArea);
        _splitPanel.setSplitPosition(getSplitterPosition(), HorizontalSplitPanel.UNITS_PIXELS);
        _splitPanel.setLocked(false); // Splitter can be resized

        buildContentPart();
    
        final UriFragmentUtility uriFragment= new UriFragmentUtility();
        uriFragment.addListener(this);
        _leftPart.addComponent(uriFragment);
        LOG.warn("Initial fragment" + uriFragment.getFragment());
        
        _folderBrowser.addListener((ValueChangeEvent event) -> {
            Object selected= event.getProperty().getValue();
            if (selected instanceof File) 
            {
                File value = (File) selected;
                
                if (value.isDirectory())
                {
                    // _contentArea.setSource(FOLDER);
                }
                else
                {
                    //FileResource fileResource = new FileResource(value,
                    //        ImageBrowser.this);
                    //image.setSource(fileResource);
                }
            }
        });

        // Notification area. Full width.
        _notifications = new Notifique(false);
        _notifications.setWidth("100%");

        // Hide messages when clicked anywhere (not only with the close
        // button)
        _notifications.setClickListener((Message message) -> {
            message.hide();
        });
        // Display as overlay in top of the main window
        // CustomOverlay ol = new CustomOverlay(_notifications, getMainWindow());
        _leftPart.addComponent(_notifications);
    }

    @Override
    public void fragmentChanged(FragmentChangedEvent source)
    {
        UriFragmentUtility fu= source.getUriFragmentUtility();
        _currentFragment= fu.getFragment();
        CKEditorAction currentAction= getCKEditorAction(getCurrentFragment());

        internalFragmentChanged(currentAction);
    }
    
    protected void internalFragmentChanged(String newFragment, HttpServletRequest request)
    {
        _currentFragment= newFragment;
        CKEditorAction currentAction= getCKEditorAction(newFragment, request);
        internalFragmentChanged(currentAction);
    }
    
    protected void internalFragmentChanged(CKEditorAction currentAction)
    {
        _currentAction= currentAction;
        if (LOG.isDebugEnabled())
        {
            LOG.debug("New fragment: "+_currentFragment);
            LOG.debug("Requested action: <"+_currentAction.getRequestedAction().name()+">");
            LOG.debug("Requested type: <"+_currentAction.getType()+">");
            LOG.debug("Remaining remaining part: <"+_currentAction.getRemainingPart()+">");
            LOG.debug("Remaining Instance: <"+_currentAction.getEditorInstance()+">");
            LOG.debug("Remaining callback FuncNum: <"+_currentAction.getEditorCallback()+">");
            LOG.debug("Remaining langCode: <"+_currentAction.getLangCode()+">");
        }
        if (null != _currentAction.getRequestedAction())
        switch (_currentAction.getRequestedAction()) {
            case FILEBROWSER:
                _isFileBrowser= true;
                browseTree(_currentAction.getType(), true);
                break;
            case LINKBROWSER:
                _isFileBrowser= false;
                browseTree(_currentAction.getType(), false);
                break;
            default:
                getMainWindow().showNotification("Unhandled action", _currentAction.getRequestedAction().name(), Notification.TYPE_ERROR_MESSAGE);
                break;
        }
    }

    protected void browseTree(String fileType, boolean browseFiles)
    {
        IToolbar tbProvider= null;
        if (_showAsList)
        {
            if (_contentTable != null)
            {
                _contentTable.setContainerDataSource(null);
            }
        }
        else
        {
            if (_contentFlow != null)
            {
                _contentFlow.setContainerDataSource(null);
            }
        }
                    
        _folderContainer= getBrowseContainer(fileType, browseFiles);
        _folderBrowser.setContainerDataSource(_folderContainer);
        _folderBrowser.setColumnExpandRatio(_folderBrowser.getHierarchyColumnId() /*CollapsibleFileSystemContainer.PROPERTY_NAME */, 1);
        // _folderBrowser.setItemIconPropertyId(CollapsibleFileSystemContainer.PROPERTY_ICON);
        
        _folderBrowser.setColumnReorderingAllowed(true);
        Object fp= _folderContainer.getFolderProvider();
        // Remove old toolbar (if existed)
        if (_folderToolbar != null)
        {
            _leftPart.removeComponent(_folderToolbar);
            _folderToolbar= null;
        }
        if (fp instanceof IToolbar)
        {
            tbProvider= (IToolbar) fp;
        }
        if (tbProvider != null)
        {
            Component leftTB= tbProvider.getNavigationToolbar(this);
            if (leftTB != null)
            {
                // Add on top
                _leftPart.addComponent(leftTB, 0);
                _folderToolbar= leftTB;
            }
        }

        boolean showDetail= _folderContainer.getFolderProvider().showDetailScreen();
        if (showDetail)
        {
            HorizontalLayout hl= new HorizontalLayout();
            hl.setWidth(100,HorizontalLayout.UNITS_PERCENTAGE);
            _splitPanel.setSplitPosition(getSplitterPosition(), HorizontalSplitPanel.UNITS_PIXELS);
            Component tbDetail= (tbProvider != null ? tbProvider.getDetailScreenToolbar(this) : null);
            _topArea.removeAllComponents();
            if (tbDetail != null )
            {
                _topArea.addComponent(tbDetail);
                _topArea.addComponent(hl);
                _captionLabel= new Label("Please select a folder from the left side");
                hl.addComponent(_captionLabel);
                _captionLabel.setWidth(100, Label.UNITS_PERCENTAGE);
                hl.setExpandRatio(_captionLabel, 1);
                _contentArea.addComponent(_topArea, BorderLayout.Constraint.NORTH);
            }
            else
            {
                _captionLabel= new Label("Please select a folder from the left side");
                hl.addComponent(_captionLabel);
                hl.setExpandRatio(_captionLabel, 1);
                _topArea.addComponent(hl);
                _captionLabel.setWidth(100, Label.UNITS_PERCENTAGE);
                _contentArea.addComponent(_topArea, BorderLayout.Constraint.NORTH);
            }
            Button listView= new Button();
            listView.setDescription("Show items as list");
            listView.setIcon(new ThemeResource("../../icons/list_view.gif"));
            hl.addComponent(listView);
            listView.addListener((ClickListener) (ClickEvent event) -> {
                if (!_showAsList)
                {
                    _showAsList= true;
                    //_cookies.setCookie(getCookieName()+"ShowAsList", "1", getCookieExpiration());
                    switchToList();
                }
            });
            Button galView= new Button();
            galView.setDescription("Show items as gallery with preview");
            galView.setIcon(new ThemeResource("../../icons/gallery_view_on.gif"));
            hl.addComponent(galView);
            galView.addListener((ClickListener) (ClickEvent event) -> {
                if (_showAsList)
                {
                    //_cookies.setCookie(getCookieName()+"ShowAsList", "0", getCookieExpiration());
                    _showAsList= false;
                    switchToGrid();
                }
                else
                {
                    // Ignore, already grid view
                }
            });
        }
        else
        {
            _splitPanel.setSplitPosition(100, HorizontalSplitPanel.UNITS_PERCENTAGE);
        }
        _folderBrowser.setSelectable(showDetail);
        _folderBrowser.setMultiSelect(false);
        _folderBrowser.setImmediate(true);
        _folderBrowser.setColumnIcon(_folderBrowser.getHierarchyColumnId() /*CollapsibleFileSystemContainer.PROPERTY_NAME */,
                new ThemeResource("../runo/icons/16/document.png"));
        _folderBrowser.addListener((ValueChangeEvent event) -> {
            // Item selected
            Object obj= event.getProperty().getValue();
            if (obj != null)
            {
                IFolder selFolder= (IFolder) obj;
                showFolder(selFolder);
            }
            else
            {
                LOG.debug("Selected : "+(obj != null ? obj.toString() : "Null"));
            }
        });
        if (showDetail)
        {
            Container.Hierarchical treeSrc= _folderBrowser.getContainerDataSource();
            if (treeSrc != null)
            {
                Collection<?> rootNodes= treeSrc.rootItemIds();
                if (rootNodes != null && !rootNodes.isEmpty())
                {
                    Iterator<?> iNodes= rootNodes.iterator();
                    if (iNodes.hasNext())
                    {
                        Object firstNode= iNodes.next();
                        if (firstNode != null)
                        {
                            _folderBrowser.setValue(firstNode);
                        }
                    }
                }
            }
        }
    }

    // http://stackoverflow.com/questions/1498628/how-can-you-integrate-a-custom-file-browser-uploader-with-ckeditor
    protected void fileSelected(String selFile)
    {
        LOG.warn("file selected: "+selFile);
        _mainWindow.executeJavaScript("window.opener.CKEDITOR.tools.callFunction("+_currentAction.getEditorCallback()+",'"+StringEscapeUtils.escapeJavaScript(selFile)+"');window.close()");
    }

    protected void showErrorMessage(String message)
    {
        _mainWindow.executeJavaScript("window.close();window.opener.CKEDITOR.tools.callFunction("+_currentAction.getEditorCallback()+",null,'"+StringEscapeUtils.escapeJavaScript(message)+"')");
    }

    protected FolderContainer getBrowseContainer(String type, boolean isFileBrowser)
    {
        IProvider provider= isFileBrowser ? getFileProvider(type) : getLinkProvider(type);
        return new FolderContainer(provider, type, isFileBrowser);
    }


    public static String getFilebrowserBrowseUrl()
    {
        return getBrowserURL()+"#"+CK_ACTIONS.FILEBROWSER.name();
    }


    public static String getFilebrowserImageBrowseUrl()
    {
        return getBrowserURL()+"#"+CK_ACTIONS.FILEBROWSER.name()+"/type/Images";
    }


    public static String getFilebrowserFlashBrowseUrl()
    {
        return getBrowserURL()+"#"+CK_ACTIONS.FILEBROWSER.name()+"/type/Flash";
    }


    public static String getFilebrowserLinkBrowseUrl()
    {
        return getBrowserURL()+"#"+CK_ACTIONS.LINKBROWSER.name();
    }

    public static String getFilebrowserImageBrowseLinkUrl()
    {
        return getFilebrowserLinkBrowseUrl();
    }


    public static String getFilebrowserFlashBrowseLinkUrl()
    {
        return getFilebrowserLinkBrowseUrl();
    }
    

    public static String getFilebrowserUploadUrl()
    {
        return getDirectuploadURL()+CK_ACTIONS.UPLOADER.name()+"/type/Files";
    }


    public static String getFilebrowserImageUploadUrl()
    {

        return getDirectuploadURL()+CK_ACTIONS.UPLOADER.name()+"/type/Images";
    }


    public static String getFilebrowserFlashUploadUrl()
    {
        return getDirectuploadURL()+CK_ACTIONS.UPLOADER.name()+"/type/Flash";
    }

    /**
     * This method returns the file provider to browse/upload files
     * 
     * @param type Can be Images,Flash and Files (and null)
     * @return The provider for file handling/browsing
     */
    protected IProvider getFileProvider(String type)
    {
        return new FileSystemProvider();
    }

    /**
     * This method returns the link provider to browse links
     * 
     * @param type Usually null
     * @return The provider for folder/link handling/browsing
     */
    protected IProvider getLinkProvider(String type)
    {
        return new FileSystemProvider();
    }
    
    /**
     * Show content of this folder
     * 
     * @param folder
     */
    protected void showFolder(IFolder folder)
    {
        if (folder != null)
        {
            _captionLabel.setValue("Content of folder: "+folder.getName());
            _objectContainer= new ObjectContainer(folder, this);
            if (_showAsList)
            {
                _contentTable.setContainerDataSource(_objectContainer);
            }
            else
            {
                _contentFlow.setContainerDataSource(_objectContainer);
            }
            if (folder.isUploadAllowed())
            {
                WebBrowser browser = (WebBrowser) _mainWindow.getTerminal();
                if (browser.isIE())
                {
                    LOG.debug("Simple fileupload for IE in folder: "+folder.getURL());
                    if (_uploadAreaS != null)
                    {
                        _topArea.removeComponent(_uploadAreaS);
                    }
                    _uploadAreaS= new SimpleFileUploader(this, folder);
                    _topArea.addComponent(_uploadAreaS);
                }
                else
                {
                    _uploadAreaM= new FileUploader(this, folder);
                    _contentArea.addComponent(_uploadAreaM, BorderLayout.Constraint.EAST);
                }
            }
            else
            {
                if (_uploadAreaM != null)
                {
                    _contentArea.removeComponent(_uploadAreaM);
                }
                _uploadAreaM= null;
                if (_uploadAreaS != null)
                {
                    _topArea.removeComponent(_uploadAreaS);
                }
                _uploadAreaS= null;
            }
        }
    }

    /**
     * Reload folder content after a upload, rename etc.
     * 
     */
    public void updateFolder()
    {
        _objectContainer.refresh();
    }

    /**
     * @return the _splitterPosition
     */
    public int getSplitterPosition() {
        return _splitterPosition;
    }

    /**
     * @param splitterPosition the _splitterPosition to set
     */
    public void setSplitterPosition(int splitterPosition) {
        this._splitterPosition = splitterPosition;
    }

    /**
     * @return the _currentFragment
     */
    public String getCurrentFragment() {
        return _currentFragment;
    }

    
    @Override
    public void onRequestStart(HttpServletRequest request, HttpServletResponse response) 
    {
        String initialFragment= request.getParameter("fr");  // Could be null.
        if (initialFragment != null)
        {
            LOG.debug("Request fragment: "+initialFragment);
            internalFragmentChanged(initialFragment, request);
        }
    }

    @Override
    public void onRequestEnd(HttpServletRequest request, HttpServletResponse response) 
    {
        // throw new UnsupportedOperationException("Not supported yet.");
    }

    public class DetailColumnGenerator implements Table.ColumnGenerator, FlowLayout.ColumnGenerator
    {
        private static final long serialVersionUID = 1L;
        @Override
        public Component generateCell(Table source, Object itemId, Object columnId)
        {
            Component retVal= generateCell(itemId, columnId);
            return retVal;
        }
        
        @Override
        public Component generateCell(FlowLayout source, Object itemId, Object columnId)
        {
            Component retVal= generateCell(itemId, columnId);
            return retVal;
        }
        
        protected Component generateCell(Object itemId, Object columnId)
        {
            IObject fileObject= (IObject) itemId;

            HorizontalLayout hl= new HorizontalLayout();
            if (fileObject.isSelectAllowed())
            {
                Button selButton= new Button("Select");
                selButton.setData(itemId);
                selButton.addListener((ClickListener) (ClickEvent event) -> {
                    Object itemId1 = event.getButton().getData();
                    if (itemId1 instanceof IObject) {
                        IObject obj = (IObject) itemId1;
                        fileSelected(obj.getURL());
                    }
                });
                hl.addComponent(selButton);
            }
            if (fileObject.isDeleteAllowed())
            {
                Button delButton= new Button("Delete");
                delButton.setData(itemId);
                delButton.addListener((ClickListener) (ClickEvent event) -> {
                    Object itemId1 = event.getButton().getData();
                    if (itemId1 instanceof IObject) {
                        final IObject obj = (IObject) itemId1;
                        ConfirmDialog.show(_mainWindow,
                                "Please confirm:",
                                "Do you wish to delete <"+obj.getName()+"> ?",
                                "Yes", "No", (ConfirmDialog dialog) -> {
                                    if (dialog.isConfirmed())
                                    {
                                        // Confirmed to continue
                                        LOG.info("Delete file <"+obj.getName()+">");
                                        if (obj.delete())
                                        {
                                            // Also remove from detail view
                                            _objectContainer.removeItem(obj);
                                        }
                                        else
                                        {
                                            _mainWindow.showNotification("Delete failed", "Failed to delete <"+obj.getName()+">");
                                        }
                                    }
                                    else
                                    {
                                        // User did not confirm
                                        // feedback(dialog.isConfirmed());
                                    }
                        });
                    }
                });
                hl.addComponent(delButton);
            }
            if (fileObject.isRenameAllowed())
            {
                Button renButton= new Button("Rename");
                renButton.setData(itemId);
                renButton.addListener((ClickListener) (ClickEvent event) -> {
                    Object itemId1 = event.getButton().getData();
                    if (itemId1 instanceof IObject) {
                        final IObject obj = (IObject) itemId1;
                        ObjectNameDialog dialog= new ObjectNameDialog(
                                "Rename object", "New object name",
                                obj.getName(), true, (String newName) -> {
                                    if (!obj.handleRename(newName))
                                    {
                                        showErrorNotification("Rename failed");
                                    }
                                    else
                                    {
                                        // Update tree
                                        _objectContainer.refresh();
                                    }
                        });
                        _mainWindow.addWindow(dialog);
                    }
                });
                hl.addComponent(renButton);
            }
            if (fileObject.isResizeAllowed())
            {
                Button resButton= new Button("Resize");
                resButton.setData(itemId);
                resButton.addListener((ClickListener) (ClickEvent event) -> {
                    Object itemId1 = event.getButton().getData();
                    if (itemId1 instanceof IObject) {
                        IObject obj = (IObject) itemId1;
                        fileSelected(obj.getURL());
                    }
                });
                hl.addComponent(resButton);
            }
            return hl;
        }

    }

    public class FolderColumnGenerator implements ColumnGenerator
    {
        private static final long serialVersionUID = 1L;
        @Override
        public Component generateCell(Table source, Object itemId, Object columnId)
        {
            IFolder folderObject= (IFolder) itemId;

            HorizontalLayout hl= new HorizontalLayout();
            if (folderObject.isSelectAllowed())
            {
                Button selButton= new Button("Select");
                selButton.setData(itemId);
                selButton.addListener((ClickListener) (ClickEvent event) -> {
                    Object itemId1 = event.getButton().getData();
                    if (itemId1 instanceof IFolder) {
                        IFolder obj = (IFolder) itemId1;
                        fileSelected(obj.getURL());
                    }
                });
                hl.addComponent(selButton);
            }
            return hl;
        }

    }

    /**
     * Retrieve a string from the servlet context 
     * 
     * @param key           Key to retrieve
     * @param defaultValue  Return this value if the key is not defined in web.xml
     * @return Value of the context (web.xml)
     */
    public static String getContextString(String key, String defaultValue)
    {
        String retVal;
        try
        {
            Context initCtx = new InitialContext();

            Context envCtx = (Context) initCtx.lookup(JNDI_INITIAL_CONTEXT);
            retVal= (String) envCtx.lookup(key);
            if (LOG.isDebugEnabled())
            {
                LOG.debug("Key <"+key+"> found, so use it :<"+retVal+">");
            }
        }
        catch (Exception ex)
        {
            if (LOG.isDebugEnabled())
            {
                LOG.debug("Key <"+key+"> not found, so use default :<"+defaultValue+">");
            }
            retVal= defaultValue;
        }
        return retVal;
    }

    public void showInfoNotification(String message)
    {
        _notifications.add(null,
                message,
                true, Notifique.Styles.INFO, true);
    }

    public void showWarningNotification(String message)
    {
        _notifications.add(null,
                message,
                true, Notifique.Styles.WARNING, true);
    }

    public void showErrorNotification(String message)
    {
        _notifications.add(null,
                message,
                true, Notifique.Styles.ERROR, true);
    }

    protected static String getBrowserURL()
    {
        return getContextString("ckeditor.connector", "servlet/ckeditorconnector/");
    }

    protected static String getDirectuploadURL()
    {
        return getContextString("ckeditor.connector-dup", "servlet/ckeditorconnector-dup/");
    }

    /**
     * This returns the instance used to parse the URL
     * 
     * @param fragment
     * @return 
     */
    protected CKEditorAction getCKEditorAction(String fragment)
    {
        return new CKEditorAction(fragment);
    }

    /**
     * This returns the instance used to parse the URL
     * 
     * @param fragment
     * @param request
     * @return 
     */
    protected CKEditorAction getCKEditorAction(String fragment, HttpServletRequest request)
    {
        return new CKEditorAction(fragment, request);
    }
    
    protected void buildContentPart()
    {
        if (_showAsList)
        {
            _contentTable= new Table();
            _contentTable.setSizeFull();
            _contentArea.addComponent(_contentTable, BorderLayout.Constraint.CENTER);
            _contentTable.addGeneratedColumn("ACTION", new DetailColumnGenerator());
            // Not yet _contentTable.setMultiSelect(true);

            _contentTable.setCellStyleGenerator((final Object itemId, final Object propertyId) -> {
                if (propertyId != null) 
                {
                    if (propertyId.equals(ObjectContainer.OBJECT_PROPERTY_NAME))
                    {
                        if (itemId instanceof IIconProvider) 
                        {
                            IIconProvider iItem= (IIconProvider) itemId;
                            String icon= iItem.getListIcon();
                            return icon;
                        }
                        else
                        {
                            return null;
                        }
                    }
                    else
                    {
                        return null;
                    }
                }
                else
                {
                    return null;
                }
            });
        }
        else
        {
            _flowPanel= new Panel();
            _flowPanel.addStyleName(Panel.STYLE_LIGHT);
            _flowPanel.setSizeFull();
            _contentFlow= new FlowLayout();
            _contentArea.addComponent(_flowPanel, BorderLayout.Constraint.CENTER);
            _flowPanel.addComponent(_contentFlow);
            _contentFlow.addGeneratedColumn("ACTION", new DetailColumnGenerator());
        }
    }
    
    /**
     * Use this cookie to store grid/list view last used
     * @return 
     */
    protected String getCookieName()
    {
        return COOKIE_NAME;
    }
    
    /**
     * How long should the cookies be set
     * We default to 60 days
     * @return 
     */
    protected Date getCookieExpiration()
    {
        Date expireDate= new Date();
        long expire= expireDate.getTime()+1000L*60L*60L*24L*60L;
        return new Date(expire);
    }
    
    protected void switchToGrid()
    {
        buildContentPart();
        if (_contentTable != null && _contentTable.getContainerDataSource() != null)
        {
            _contentFlow.setContainerDataSource((IndexedContainer)_contentTable.getContainerDataSource());
        }
        else
        {
            // Ignore, already grid view
        }
    }

    protected void switchToList()
    {
        buildContentPart();
        if (_contentFlow != null)
        {
            _contentTable.setContainerDataSource((IndexedContainer)_contentFlow.getContainerDataSource());
        }
        else
        {
            // Ignore, already list view
        }
    }
}
